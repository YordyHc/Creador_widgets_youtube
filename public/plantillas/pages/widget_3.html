<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="../assets/style/widget_3.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <title>Lista Vertical</title>
  </head>

  <body>
    <div class="con_1">
      <!-- Botón de "Anterior" (arriba) -->
      <button id="prevBtn" class="nav-button">
        <i class="fa-solid fa-chevron-up"></i>
      </button>

      <!-- LISTA / GRUPOS DINÁMICOS -->
      <div class="lista" id="lista"></div>

      <!-- Botón de "Siguiente" (abajo) -->
      <button id="nextBtn" class="nav-button">
        <i class="fa-solid fa-chevron-down"></i>
      </button>
    </div>

    <!-- ==========================================================
     MODAL NUEVO ADAPTADO
========================================================== -->
    <div id="myModal" class="modal-overlay" style="display: none">
      <button class="modal-close"><i class="fa-solid fa-xmark"></i></button>

      <div class="modal-content">
        <div class="video-iframe-container">
          <iframe
            id="videoFrame"
            width="100%"
            height="400"
            src=""
            frameborder="0"
            allow="autoplay; encrypted-media"
            allowfullscreen=""
          ></iframe>
        </div>

        <div class="modal-info">
          <h3 id="modal_titulo" class="md_title"></h3>

          <div class="md-stats">
            <p class="md-info">
              <span id="md_views"></span> <i class="fa-solid fa-eye"></i>
            </p>

            <p class="md-info likes">
              <i class="fa-solid fa-thumbs-up"></i>
              <span id="md_likes"></span>
            </p>
          </div>

          <div class="profile-md">
            <a class="logo_href" href="#" target="_blank">
              <img class="logo img_perfil" alt="Logo del canal" />
            </a>

            <div class="pf-data">
              <h6>
                <a class="canal_url" href="#" target="_blank"></a>
              </h6>
              <p class="md-info-fecha" id="md_fecha"></p>
              <p class="md-description" id="md_description"></p>
            </div>

            <a class="yt_button_url subscribe-btn" href="#" target="_blank">
              <i class="fa-brands fa-youtube"></i>
              <span class="spn-you-subs"></span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/script/herramientas.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <!-- ==========================================================
     SCRIPT PARA DATOS, LISTA Y MODAL
========================================================== -->
    <script>
      let videosData = [];
      let canalData = null;

      /* ==========================================================
   RECIBE DATOS DEL PARENT
========================================================== */
      window.addEventListener("message", (event) => {
        if (!event.data) return;

        const { datos, videos } = event.data;

        if (datos) canalData = datos;

        if (videos) {
          videosData = videos;
          construirLista();
        }
      });

      /* ==========================================================
    GENERA LA LISTA VERTICAL
========================================================== */
      function construirLista() {
        const lista = document.getElementById("lista");
        lista.innerHTML = "";

        const chunkSize = 4;
        let grupos = [];

        for (let i = 0; i < videosData.length; i += chunkSize) {
          grupos.push(videosData.slice(i, i + chunkSize));
        }

        grupos.forEach((grupo) => {
          const groupDiv = document.createElement("div");
          groupDiv.classList.add("video-group");

          grupo.forEach((video) => {
            const item = document.createElement("div");
            item.classList.add("video-item");
            item.dataset.videoId = video.id;

            item.onclick = () => playvideo(video);

            item.innerHTML = `
                <div class="miniatura">
                    <img src="${video.thumbnail}" alt="Imagen">
                    <button class="play-button"></button>
                    <span class="video-duration">${formatYouTubeDuration(
                      video.duration
                    )}</span>
                </div>

                <div class="descripcion">
                    <div class="vd_titulo"><strong>${video.title}</strong></div>
                    <div class="video-info">${formatearFecha(
                      video.publishedAt
                    )}</div>
                    <div class="vd-dscpn">${video.description}</div>
                    <div class="video-info">
                        ${redondeo(video.viewCount)} vistas • 
                        ${redondeo(video.likeCount)} likes • 
                        ${redondeo(video.commentCount)} comentarios
                    </div>
                </div>
            `;

            groupDiv.appendChild(item);
          });

          lista.appendChild(groupDiv);
        });

        iniciarNavegación();
      }

      /* ==========================================================
    NAVEGACIÓN (UP/DOWN)
========================================================== */
      function iniciarNavegación() {
        let index = 0;
        const groups = document.querySelectorAll(".video-group");

        function actualizar() {
          groups.forEach(
            (g, i) => (g.style.display = i === index ? "block" : "none")
          );
        }

        actualizar();

        document.getElementById("nextBtn").onclick = () => {
          if (index < groups.length - 1) {
            index++;
            actualizar();
          }
        };

        document.getElementById("prevBtn").onclick = () => {
          if (index > 0) {
            index--;
            actualizar();
          }
        };
      }

      /* ==========================================================
    MODAL
========================================================== */
      const modal = document.getElementById("myModal");
      const closeBtn = document.querySelector(".modal-close");
      const videoFrame = document.getElementById("videoFrame");

      function playvideo(video) {
        modal.style.display = "flex";
        videoFrame.src = `https://www.youtube.com/embed/${video.id}?autoplay=1&rel=0`;

        document.getElementById("modal_titulo").innerText = video.title;
        document.getElementById("md_views").innerText = `${redondeo(
          video.viewCount
        )} vistas `;
        document.getElementById("md_likes").innerText = `${redondeo(
          video.likeCount
        )}`;
        document.getElementById("md_fecha").innerText = formatearFecha(
          video.publishedAt
        );
        document.getElementById("md_description").innerText = video.description;

        /* Datos del canal */
        if (canalData) {
          document.querySelector(".img_perfil").src = canalData.logoUrl;
          document.querySelector(".logo_href").href =
            document.querySelector(".canal_url").href =
            document.querySelector(".yt_button_url").href =
              `https://www.youtube.com/channel/${canalData.idcanal}`;

          document.querySelector(".canal_url").textContent = canalData.title;
          document.querySelector(
            ".spn-you-subs"
          ).textContent = `Youtube ${redondeo(canalData.subscriberCount)}`;
        }
      }

      /* Cerrar modal */
      closeBtn.onclick = () => {
        modal.style.display = "none";
        videoFrame.src = "";
      };

      window.onclick = (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
          videoFrame.src = "";
        }
      };
    </script>
  </body>
</html>
