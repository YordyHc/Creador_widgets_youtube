<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <link rel="stylesheet" href="../assets/style/widget_2.css" />

    <title>widget 2</title>
  </head>

  <body>
    <br />
    <center>
      <!-- ========================= -->
      <!--  CARRUSEL DINÁMICO        -->
      <!-- ========================= -->
      <div class="carousel-container">
        <div class="carousel-wrapper" id="carouselWrapper"></div>

        <div class="nav-buttons">
          <button id="prevBtn">❮</button>
          <button id="nextBtn">❯</button>
        </div>
      </div>
    </center>
    <!-- ========================= -->
    <!--  MODAL                   -->
    <!-- ========================= -->
    <div id="myModal" class="modal-overlay" style="display: none">
      <button class="modal-close"><i class="fa-solid fa-xmark"></i></button>
      <div class="modal-content">
        <div class="video-iframe-container">
          <iframe
            id="videoFrame"
            width="100%"
            height="400"
            src=""
            frameborder="0"
            allow="autoplay; encrypted-media"
            allowfullscreen=""
            title="YouTube video player"
          ></iframe>
        </div>

        <div class="modal-info">
          <h3 id="modal_titulo" class="md_title"></h3>
          <div class="md-stats">
            <p class="md-info">
              <span id="md_views"></span><i class="fa-solid fa-eye"></i>
            </p>
            <p class="md-info likes">
              <i class="fa-solid fa-thumbs-up"></i>
              <span id="md_likes"></span>
            </p>
          </div>
          <div class="profile-md">
            <a
              class="logo_href"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              ><img class="logo img_perfil" alt="Logo del canal"
            /></a>
            <div class="pf-data">
              <strong
                ><h6>
                  <a
                    class="canal_url"
                    href="#"
                    target="_blank"
                    rel="noopener noreferrer"
                  ></a></h6
              ></strong>
              <p class="md-info-fecha" id="md_fecha"></p>
              <p class="md-description" id="md_description"></p>
            </div>
            <a
              class="yt_button_url subscribe-btn"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
            >
              <i class="fa-brands fa-youtube"></i
              ><span class="spn-you-subs"></span>
            </a>
          </div>
        </div>
      </div>
    </div>
    <br />

    <!-- ========================= -->
    <!--    SCRIPTS                -->
    <!-- ========================= -->
    <script src="../assets/script/herramientas.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <script>
      let videosData = [];
      let currentSlide = 0;

      /* =============================================================
      RECEPCIÓN DE DATOS DESDE REACT
      ============================================================= */
      window.addEventListener("message", (event) => {
        if (!event.data) return;
        if (!event.data.videos) return;

        const datos = event.data.datos;
        // Ordena los videos: más nuevo → más viejo
        document.querySelectorAll(".img_perfil").forEach((img) => {
          img.src = datos.logoUrl;
        });

        document.querySelectorAll(".canal_url").forEach((el) => {
          el.href = "https://www.youtube.com/channel/" + datos.idcanal;
          el.textContent = datos.title;
        });
        document.querySelectorAll(".logo_href").forEach((el) => {
          el.href = "https://www.youtube.com/channel/" + datos.idcanal;
        });
        document.querySelectorAll(".yt_button_url").forEach((el) => {
          el.href = "https://www.youtube.com/channel/" + datos.idcanal;
        });
        document.querySelectorAll(".spn-you-subs").forEach((spn) => {
          spn.textContent = "Youtube " + redondeo(datos.subscriberCount);
        });
        videosData = event.data.videos;

        buildCarousel(videosData);
      });

      /* =============================================================
      BUILD DEL CARRUSEL
      ============================================================= */
      function buildCarousel(videos) {
        const wrapper = document.getElementById("carouselWrapper");
        wrapper.innerHTML = "";

        const slides = chunkArray(videos, 16);

        slides.forEach((block) => {
          const slide = document.createElement("div");
          slide.classList.add("carousel-slide");

          block.forEach((video) => {
            slide.appendChild(createVideoItem(video));
          });

          wrapper.appendChild(slide);
        });

        updateCarousel();
      }

      function createVideoItem(video) {
        const container = document.createElement("div");
        container.classList.add("video-item");
        container.dataset.videoId = video.id;

        container.onclick = () => playvideo(video);

        container.innerHTML = `
          <img src="${video.thumbnail}" class="thumbnail" />

          <button class="play-button"></button>

          <span class="video-duration">${formatYouTubeDuration(
            video.duration
          )}</span>

          <div class="overlay">
            <br />
            <div class="vd_titulo">
              <strong>${video.title}</strong>
            </div>

            <div class="video-info">
              ${formatearFecha(video.publishedAt)}
            </div>

            <div class="vd-dscpn">${video.description}</div>

            <div class="video-info">
              ${redondeo(video.viewCount)} vistas •
              ${redondeo(video.likeCount)} likes •
              ${redondeo(video.commentCount)} comentarios
            </div>
          </div>
        `;

        return container;
      }

      /* =============================================================
      UTILITY
      ============================================================= */
      function chunkArray(arr, size) {
        const res = [];
        for (let i = 0; i < arr.length; i += size) {
          res.push(arr.slice(i, i + size));
        }
        return res;
      }

      /* =============================================================
      CARRUSEL
      ============================================================= */
      document.getElementById("nextBtn").onclick = () => {
        const slides = document.querySelectorAll(".carousel-slide").length;
        if (currentSlide < slides - 1) currentSlide++;
        updateCarousel();
      };

      document.getElementById("prevBtn").onclick = () => {
        if (currentSlide > 0) currentSlide--;
        updateCarousel();
      };

      function updateCarousel() {
        const wrapper = document.querySelector(".carousel-wrapper");
        wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
      }

      /* =============================================================
      MODAL
      ============================================================= */
      var modal = document.getElementById("myModal");
      var closeBtn = document.getElementsByClassName("modal-close")[0];
      var videoFrame = document.getElementById("videoFrame");

      function playvideo(video) {
        modal.style.display = "block";

        videoFrame.src =
          "https://www.youtube.com/embed/" +
          video.id +
          "?autoplay=1&rel=0&mute=0";

        document.getElementById("modal_titulo").innerText = video.title;

        document.getElementById("md_views").innerText =
          redondeo(video.viewCount) + " vistas ";
        document.getElementById("md_likes").innerText = redondeo(
          Number(video.likeCount)
        );

        document.getElementById("md_fecha").innerText = formatearFecha(
          video.publishedAt
        );

        document.getElementById("md_description").innerText = video.description;
      }

      closeBtn.onclick = function () {
        modal.style.display = "none";
        videoFrame.src = "";
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
          videoFrame.src = "";
        }
      };
    </script>
  </body>
</html>
